{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template gradereport_analytics/dashboard

    Comprehensive analytics dashboard template.

    Context variables required for this template:
    * course - Course object
    * analytics - Analytics data array
    * export_url - CSV export URL
    * json_url - JSON export URL

    Example context (json):
    {
        "course": {
            "id": 1,
            "fullname": "Sample Course"
        },
        "analytics": {
            "123": {
                "userid": 123,
                "assignments": {...},
                "interactive_content": {...}
            }
        },
        "export_url": "https://example.com/export",
        "json_url": "https://example.com/json"
    }
}}

<div class="analytics-dashboard">
    <div class="dashboard-header">
        <h1>{{#str}}pluginname, gradereport_analytics{{/str}} - {{course.fullname}}</h1>
        <div class="export-buttons">
            <a href="{{export_url}}" class="btn btn-primary">
                <i class="fa fa-download"></i> {{#str}}export_csv, gradereport_analytics{{/str}}
            </a>
            <a href="{{json_url}}" class="btn btn-secondary">
                <i class="fa fa-code"></i> {{#str}}export_json, gradereport_analytics{{/str}}
            </a>
        </div>
    </div>

    <div class="analytics-tabs">
        <ul class="nav nav-tabs" id="analyticsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab">
                    {{#str}}assignment_analytics, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="interactive-tab" data-bs-toggle="tab" data-bs-target="#interactive" type="button" role="tab">
                    {{#str}}interactive_content, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                    {{#str}}live_sessions, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="forums-tab" data-bs-toggle="tab" data-bs-target="#forums" type="button" role="tab">
                    {{#str}}forums_collaboration, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                    {{#str}}attendance, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="competencies-tab" data-bs-toggle="tab" data-bs-target="#competencies" type="button" role="tab">
                    {{#str}}competency_framework, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="badges-tab" data-bs-toggle="tab" data-bs-target="#badges" type="button" role="tab">
                    {{#str}}badges_certificates, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="behavioral-tab" data-bs-toggle="tab" data-bs-target="#behavioral" type="button" role="tab">
                    {{#str}}behavioral_quality, gradereport_analytics{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ta-evaluation-tab" data-bs-toggle="tab" data-bs-target="#ta-evaluation" type="button" role="tab">
                    {{#str}}ta_evaluation, gradereport_analytics{{/str}}
                </button>
            </li>
        </ul>

        <div class="tab-content" id="analyticsTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h3>Analytics Overview</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <h4>{{analytics|length}}</h4>
                                            <p>Total Students</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <h4 id="avg-grade">-</h4>
                                            <p>Average Grade %</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <h4 id="avg-attendance">-</h4>
                                            <p>Average Attendance %</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="metric-card">
                                            <h4 id="total-badges">-</h4>
                                            <p>Total Badges Earned</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments Tab -->
            <div class="tab-pane fade" id="assignments" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}assignment_analytics, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}avg_grade_pct, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}ontime_submission_rate, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}resubmission_count, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}feedback_richness, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#assignments}}
                                                {{#.}}
                                                    {{avg_grade_pct}}%
                                                {{/.}}
                                            {{/assignments}}
                                        </td>
                                        <td>
                                            {{#assignments}}
                                                {{#.}}
                                                    {{ontime_submission_rate}}%
                                                {{/.}}
                                            {{/assignments}}
                                        </td>
                                        <td>
                                            {{#assignments}}
                                                {{#.}}
                                                    {{resubmission_count}}
                                                {{/.}}
                                            {{/assignments}}
                                        </td>
                                        <td>
                                            {{#assignments}}
                                                {{#.}}
                                                    {{#feedback_richness}}
                                                        {{avg_length}} chars
                                                    {{/feedback_richness}}
                                                {{/.}}
                                            {{/assignments}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Interactive Content Tab -->
            <div class="tab-pane fade" id="interactive" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}interactive_content, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h4>H5P Interactions</h4>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>{{#str}}h5p_interactions, gradereport_analytics{{/str}}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{#analytics}}
                                            <tr>
                                                <td>User {{userid}}</td>
                                                <td>
                                                    {{#interactive_content.h5p}}
                                                        {{interaction_count}}
                                                    {{/interactive_content.h5p}}
                                                </td>
                                            </tr>
                                            {{/analytics}}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h4>Video Completion</h4>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>{{#str}}video_completion, gradereport_analytics{{/str}}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{#analytics}}
                                            <tr>
                                                <td>User {{userid}}</td>
                                                <td>
                                                    {{#interactive_content.video}}
                                                        {{completion_rate}}%
                                                    {{/interactive_content.video}}
                                                </td>
                                            </tr>
                                            {{/analytics}}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h4>SCORM Scores</h4>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>{{#str}}scorm_score, gradereport_analytics{{/str}}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{#analytics}}
                                            <tr>
                                                <td>User {{userid}}</td>
                                                <td>
                                                    {{#interactive_content.scorm}}
                                                        {{avg_score}}
                                                    {{/interactive_content.scorm}}
                                                </td>
                                            </tr>
                                            {{/analytics}}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Sessions Tab -->
            <div class="tab-pane fade" id="sessions" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}live_sessions, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}sessions_attended, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}punctuality, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}polls_answered, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}hands_raised, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#live_sessions}}
                                                {{sessions_attended}}
                                            {{/live_sessions}}
                                        </td>
                                        <td>
                                            {{#live_sessions}}
                                                {{punctuality_rate}}%
                                            {{/live_sessions}}
                                        </td>
                                        <td>
                                            {{#live_sessions}}
                                                {{polls_answered}}
                                            {{/live_sessions}}
                                        </td>
                                        <td>
                                            {{#live_sessions}}
                                                {{hands_raised}}
                                            {{/live_sessions}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forums Tab -->
            <div class="tab-pane fade" id="forums" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}forums_collaboration, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}posts_created, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}replies_made, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}response_latency, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}instructor_engagement, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}peer_rating, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#forums}}
                                                {{posts_created}}
                                            {{/forums}}
                                        </td>
                                        <td>
                                            {{#forums}}
                                                {{replies_made}}
                                            {{/forums}}
                                        </td>
                                        <td>
                                            {{#forums}}
                                                {{avg_response_latency}} min
                                            {{/forums}}
                                        </td>
                                        <td>
                                            {{#forums}}
                                                {{instructor_replies}}
                                            {{/forums}}
                                        </td>
                                        <td>
                                            {{#forums}}
                                                {{avg_peer_rating}}
                                            {{/forums}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}attendance, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}attendance_rate, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}late_percentage, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}absence_percentage, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}attendance_streak, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#attendance}}
                                                {{attendance_rate}}%
                                            {{/attendance}}
                                        </td>
                                        <td>
                                            {{#attendance}}
                                                {{late_count}}
                                            {{/attendance}}
                                        </td>
                                        <td>
                                            {{#attendance}}
                                                {{absence_count}}
                                            {{/attendance}}
                                        </td>
                                        <td>
                                            {{#attendance}}
                                                {{attendance_streak}}
                                            {{/attendance}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Competencies Tab -->
            <div class="tab-pane fade" id="competencies" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}competency_framework, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}competency_rating, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}proficiency_achieved, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}evidence_count, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}date_achieved, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#competencies}}
                                                {{rating}}
                                            {{/competencies}}
                                        </td>
                                        <td>
                                            {{#competencies}}
                                                {{proficiency_achieved}}
                                            {{/competencies}}
                                        </td>
                                        <td>
                                            {{#competencies}}
                                                {{evidence_count}}
                                            {{/competencies}}
                                        </td>
                                        <td>
                                            {{#competencies}}
                                                {{date_achieved}}
                                            {{/competencies}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Badges Tab -->
            <div class="tab-pane fade" id="badges" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}badges_certificates, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}badges_earned, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}certificate_achieved, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}time_to_certificate, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#badges}}
                                                {{.}}
                                            {{/badges}}
                                        </td>
                                        <td>
                                            {{#certificates}}
                                                {{.}}
                                            {{/certificates}}
                                        </td>
                                        <td>-</td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Behavioral Tab -->
            <div class="tab-pane fade" id="behavioral" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}behavioral_quality, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}deadline_adherence, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}learning_pace, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}academic_integrity, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#behavioral.deadline_adherence}}
                                                {{.}}%
                                            {{/behavioral.deadline_adherence}}
                                        </td>
                                        <td>
                                            {{#behavioral.learning_pace}}
                                                {{avg_pace_hours}} hours
                                            {{/behavioral.learning_pace}}
                                        </td>
                                        <td>
                                            {{#behavioral.academic_integrity}}
                                                {{avg_similarity}}%
                                            {{/behavioral.academic_integrity}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TA Evaluation Tab -->
            <div class="tab-pane fade" id="ta-evaluation" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>{{#str}}ta_evaluation, gradereport_analytics{{/str}}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>{{#str}}ta_rating, gradereport_analytics{{/str}}</th>
                                        <th>{{#str}}ta_notes, gradereport_analytics{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#analytics}}
                                    <tr>
                                        <td>User {{userid}}</td>
                                        <td>
                                            {{#ta_evaluation}}
                                                {{avg_ta_rating}}
                                            {{/ta_evaluation}}
                                        </td>
                                        <td>
                                            {{#ta_evaluation}}
                                                {{feedback_count}}
                                            {{/ta_evaluation}}
                                        </td>
                                    </tr>
                                    {{/analytics}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-dashboard {
    padding: 20px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
}

.dashboard-header h1 {
    margin: 0;
    color: #2c3e50;
}

.export-buttons {
    display: flex;
    gap: 10px;
}

.metric-card {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.metric-card h4 {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}

.metric-card p {
    margin: 0;
    color: #6c757d;
    font-size: 0.9rem;
}

.analytics-tabs {
    margin-top: 20px;
}

.nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #6c757d;
    font-weight: 500;
    padding: 12px 20px;
}

.nav-tabs .nav-link.active {
    color: #007bff;
    border-bottom-color: #007bff;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #007bff;
    color: #007bff;
}

.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 8px;
}

.card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 15px 20px;
}

.card-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.2rem;
}

.table th {
    background: #f8f9fa;
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.table td {
    vertical-align: middle;
}

.btn {
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 500;
}

.btn-primary {
    background: #007bff;
    border-color: #007bff;
}

.btn-secondary {
    background: #6c757d;
    border-color: #6c757d;
}

.table-responsive {
    border-radius: 6px;
    overflow: hidden;
}
</style>

<script>
// Calculate overview metrics
document.addEventListener('DOMContentLoaded', function() {
    const analytics = {{{analytics}}};
    
    let totalGrade = 0;
    let totalAttendance = 0;
    let totalBadges = 0;
    let userCount = 0;
    
    Object.values(analytics).forEach(user => {
        userCount++;
        
        // Calculate average grade
        if (user.assignments) {
            let userGrade = 0;
            let assignmentCount = 0;
            Object.values(user.assignments).forEach(assignment => {
                userGrade += assignment.avg_grade_pct || 0;
                assignmentCount++;
            });
            if (assignmentCount > 0) {
                totalGrade += userGrade / assignmentCount;
            }
        }
        
        // Calculate average attendance
        if (user.attendance) {
            let userAttendance = 0;
            let attendanceCount = 0;
            Object.values(user.attendance).forEach(att => {
                userAttendance += att.attendance_rate || 0;
                attendanceCount++;
            });
            if (attendanceCount > 0) {
                totalAttendance += userAttendance / attendanceCount;
            }
        }
        
        // Count badges
        if (user.badges) {
            totalBadges += Object.keys(user.badges).length;
        }
    });
    
    // Update overview metrics
    document.getElementById('avg-grade').textContent = userCount > 0 ? Math.round(totalGrade / userCount) + '%' : '-';
    document.getElementById('avg-attendance').textContent = userCount > 0 ? Math.round(totalAttendance / userCount) + '%' : '-';
    document.getElementById('total-badges').textContent = totalBadges;
});
</script>
